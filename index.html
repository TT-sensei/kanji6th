<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>6„Å≠„Çì„Åõ„ÅÑ „Åã„Çì„Åò„Éû„Çπ„Çø„ÉºÔºàÈü≥„ÅÇ„ÇäÔºâ</title>
    
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&display=swap" rel="stylesheet">

    <style>
        /* --- „Éá„Ç∂„Ç§„É≥Ë®≠ÂÆöÔºà6Âπ¥ÁîüÔºöËíºÁ©π„ÉªÁü•ÊÄß„ÉªÂçíÊ•≠Ôºâ --- */
        body {
            font-family: 'Mochiy Pop One', sans-serif;
            background-color: #E8EAF6; /* ËñÑ„ÅÑËóçËâ≤ */
            margin: 0; padding: 0;
            min-height: 100vh;
            color: #1A237E; /* Ê∑±„ÅÑËóçËâ≤ */
            overflow-x: hidden;
            touch-action: manipulation;
            user-select: none;
            box-sizing: border-box;
        }

        /* ÁîªÈù¢ÂÖ±ÈÄö */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center; justify-content: center;
            width: 100%; min-height: 100vh;
            padding: 20px; box-sizing: border-box;
            opacity: 0; transition: opacity 0.3s;
        }
        .screen.active { display: flex; opacity: 1; }

        /* „Çø„Ç§„Éà„É´ÁîªÈù¢ */
        #title-screen { 
            background: linear-gradient(135deg, #283593 0%, #1A237E 100%);
            position: relative; overflow: hidden;
        }
        /* Áü•ÊÄß„ÇíÊÑü„Åò„ÇãÂπæ‰ΩïÂ≠¶Ê®°Êßò„ÅÆËÉåÊôØ */
        #title-screen::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(30deg, rgba(255,255,255,0.05) 12%, transparent 12.5%, transparent 87%, rgba(255,255,255,0.05) 87.5%, rgba(255,255,255,0.05)),
                linear-gradient(150deg, rgba(255,255,255,0.05) 12%, transparent 12.5%, transparent 87%, rgba(255,255,255,0.05) 87.5%, rgba(255,255,255,0.05)),
                linear-gradient(30deg, rgba(255,255,255,0.05) 12%, transparent 12.5%, transparent 87%, rgba(255,255,255,0.05) 87.5%, rgba(255,255,255,0.05)),
                linear-gradient(150deg, rgba(255,255,255,0.05) 12%, transparent 12.5%, transparent 87%, rgba(255,255,255,0.05) 87.5%, rgba(255,255,255,0.05));
            background-size: 80px 140px;
            background-position: 0 0, 0 0, 40px 70px, 40px 70px, 0 0, 40px 70px;
            opacity: 0.5; pointer-events: none;
        }

        .game-title {
            font-size: 2.8rem; color: #FFF; text-shadow: 4px 4px 0px #000051, 0 0 20px rgba(255,215,0,0.5);
            text-align: center; margin-bottom: 40px; line-height: 1.2;
            animation: pulse 3s infinite ease-in-out;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .mode-btn {
            width: 280px; font-size: 1.4rem; padding: 15px 0;
            border-radius: 50px; border: none; cursor: pointer;
            margin: 10px 0; color: white; font-family: inherit;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: all 0.2s; box-shadow: 0 6px 0 rgba(0,0,0,0.3);
            position: relative; overflow: hidden;
        }
        .mode-btn:active { transform: scale(0.95); box-shadow: 0 3px 0 rgba(0,0,0,0.3); }
        .mode-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 0 rgba(0,0,0,0.3); }

        .btn-practice { background: linear-gradient(to right, #FFD600, #FFAB00); color: #212121; text-shadow: 0 1px 0 rgba(255,255,255,0.4); } 
        .btn-test { background: linear-gradient(to right, #F50057, #C51162); } 

        /* ‰∏ÄË¶ßÁîªÈù¢ */
        #list-screen { justify-content: flex-start; padding-top: 20px; }
        .header-info {
            background: white; padding: 15px; border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px;
            display: flex; flex-direction: column; align-items: center;
            width: 90%; max-width: 600px;
        }
        .mode-badge {
            font-size: 1rem; padding: 5px 15px; border-radius: 20px;
            color: white; margin-bottom: 5px; font-weight: bold;
        }
        
        #search-input {
            width: 80%; padding: 10px; font-size: 1.2rem; margin: 10px 0;
            border: 2px solid #7986CB; border-radius: 10px;
            font-family: inherit; text-align: center; outline: none;
            background-color: #E8EAF6;
        }
        #search-input:focus { border-color: #1A237E; background-color: #FFF; }

        .kanji-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(65px, 1fr));
            gap: 12px; width: 100%; max-width: 800px; padding-bottom: 50px;
        }
        .kanji-card {
            background: white; aspect-ratio: 1 / 1; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; cursor: pointer; box-shadow: 0 4px 0px #9FA8DA;
            position: relative; border: 2px solid transparent;
            transition: transform 0.1s;
        }
        .kanji-card:active { transform: translateY(2px); box-shadow: 0 2px 0px #9FA8DA; }
        
        .mark {
            position: absolute; top: -8px; right: -8px; font-size: 1.4rem;
            text-shadow: 1px 1px 0 #FFF; display: none; z-index: 2;
        }
        
        /* „ÇØ„É™„Ç¢ÊôÇ„ÅÆËâ≤ */
        .cleared-practice { 
            background-color: #FFFDE7; border-color: #FFD600; 
            box-shadow: 0 4px 0 #FBC02D !important;
        }
        .cleared-practice .star-mark { display: block; animation: pop 0.4s; }
        
        .cleared-test { 
            background-color: #FCE4EC; border-color: #F50057; 
            box-shadow: 0 4px 0 #C51162 !important;
        }
        .cleared-test .crown-mark { display: block; animation: pop 0.4s; }

        /* Á∑¥ÁøíÁîªÈù¢ */
        #practice-screen { background-color: #E8EAF6; position: relative; }
        #practice-screen.test-bg { background-color: #F3E5F5; } 
        .practice-header {
            width: 100%; max-width: 600px; display: flex;
            justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
        .nav-btn {
            background: #304FFE; color: white; border: none; padding: 8px 16px;
            border-radius: 20px; cursor: pointer; font-family: inherit;
            box-shadow: 0 3px 0 #1A237E; white-space: nowrap;
        }
        .nav-btn:active { transform: translateY(2px); box-shadow: 0 1px 0 #1A237E; }

        /* Ë™≠„ÅøË°®Á§∫„Ç®„É™„Ç¢ */
        .reading-container {
            flex-grow: 1; text-align: center; padding: 0 10px;
            display: flex; flex-direction: column; justify-content: center;
        }
        .target-char-display { 
            font-size: 2.2rem; color: #1A237E; font-weight: bold; 
            line-height: 1.2;
        }
        .reading-detail {
            font-size: 0.95rem; color: #283593; margin-top: 5px;
            line-height: 1.4; word-break: keep-all;
        }

        .canvas-container {
            background: white; padding: 10px; border-radius: 20px;
            box-shadow: 0 8px 0px #5C6BC0; margin-bottom: 15px; position: relative;
        }
        #character-target-div { width: 300px; height: 300px; touch-action: none; }
        #message-area { height: 30px; font-size: 1.2rem; color: #333; text-align: center; font-weight: bold; }
        
        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes pop {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        .reward-animation {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 10rem; animation: pop 0.5s ease-out; pointer-events: none;
            display: none; z-index: 100; text-shadow: 0 0 30px rgba(255, 255, 255, 1);
        }

        /* ÁµêÊûú„É°„Éã„É•„Éº */
        #result-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); display: none;
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 200; border-radius: 20px;
        }
        #result-overlay.active { display: flex; }

        .result-title { font-size: 2.5rem; margin-bottom: 20px; text-shadow: 2px 2px 0 #FFF; }
        .result-btn {
            width: 240px; padding: 15px; margin: 8px 0; border: none; border-radius: 50px;
            font-size: 1.2rem; font-family: inherit; color: white; cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: transform 0.1s;
        }
        .result-btn:active { transform: scale(0.95); }
        .btn-next { background: #3949AB; } 
        .btn-retry { background: #FFD600; color: #333; }
        .btn-home { background: #78909C; }

    </style>
</head>
<body>

    <div id="title-screen" class="screen active">
        <div class="game-title">6„Å≠„Çì„Åõ„ÅÑ<br>„Åã„Çì„Åò<br>„Éû„Çπ„Çø„Éº</div>
        <button class="mode-btn btn-practice" onclick="selectMode('practice')"><span>‚≠ê</span> „Çå„Çì„Åó„ÇÖ„ÅÜ</button>
        <button class="mode-btn btn-test" onclick="selectMode('test')"><span>üëë</span> „ÉÜ„Çπ„Éà</button>
    </div>

    <div id="list-screen" class="screen">
        <div class="header-info">
            <div id="mode-display" class="mode-badge"></div>
            <input type="text" id="search-input" placeholder="„Åï„Åå„ÅôÔºà„Åã„Çì„Åò„Éª„Çà„ÅøÔºâ" oninput="renderList()">
            <div style="font-size:1.1rem; margin-top:5px;">
                „ÅÇ„Å§„ÇÅ„ÅüÊï∞Ôºö <span id="star-counter" style="font-size:1.4rem; font-weight:bold;">0</span> / 181
            </div>
            <button class="nav-btn" onclick="showScreen('title-screen')" style="margin-top:10px; font-size:0.9rem;">„Çø„Ç§„Éà„É´„Å∏</button>
        </div>
        <div class="kanji-grid" id="kanji-grid"></div>
        <button class="nav-btn" onclick="resetData()" style="margin-top:30px; background:#B0BEC5; font-size:0.8rem;">„Éá„Éº„Çø„ÇíÊ∂à„Åô</button>
    </div>

    <div id="practice-screen" class="screen">
        <div class="practice-header">
            <button class="nav-btn" onclick="showScreen('list-screen')">„ÇÇ„Å©„Çã</button>
            <div class="reading-container">
                <div id="current-kanji-title" class="target-char-display">Êº¢Â≠ó</div>
                <div id="current-reading-detail" class="reading-detail">„Çà„Åø</div>
            </div>
            <div style="width: 50px;"></div>
        </div>
        <div class="canvas-container">
            <div id="character-target-div"></div>
            <div id="anim-star" class="reward-animation">‚≠ê</div>
            <div id="anim-crown" class="reward-animation">üëë</div>
        </div>
        <div id="message-area">„Å™„Åû„Å£„Å¶„Åø„Çà„ÅÜÔºÅ</div>
        
        <div id="result-overlay">
            <div class="result-title" id="result-title-text">„Åß„Åç„ÅüÔºÅ</div>
            <button class="result-btn btn-next" onclick="goNext()">„Å§„Åé„Å∏ ‚ñ∂</button>
            <button class="result-btn btn-retry" onclick="retry()">„ÇÇ„ÅÜ„ÅÑ„Å°„Å© ‚Ü∫</button>
            <button class="result-btn btn-home" onclick="showScreen('list-screen')">„Éõ„Éº„É† üè†</button>
        </div>
        
        <button class="nav-btn" onclick="retry()" style="background:#EF5350; margin-top:10px; z-index:10;">Êõ∏„ÅçÁõ¥„Åô</button>
    </div>

    <script>
        // --- ÂäπÊûúÈü≥„Ç∑„Çπ„ÉÜ„É† ---
        let audioContext;
        
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playSound(type) {
            try {
                initAudio();
                const now = audioContext.currentTime;
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);

                switch(type) {
                    case 'success': // Ê≠£Ëß£Ôºà„Éî„É≥„Éù„É≥Ôºâ
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(880, now); 
                        osc.frequency.exponentialRampToValueAtTime(1760, now + 0.1); 
                        gain.gain.setValueAtTime(0.2, now);
                        gain.gain.linearRampToValueAtTime(0, now + 0.2);
                        osc.start(now);
                        osc.stop(now + 0.2);
                        break;
                    case 'complete': // „ÇØ„É™„Ç¢Ôºà„Éï„Ç°„É≥„Éï„Ç°„Éº„É¨Ôºâ
                        const freqs = [523.25, 659.25, 783.99, 1046.50]; 
                        freqs.forEach((f, i) => {
                            const o = audioContext.createOscillator();
                            const g = audioContext.createGain();
                            o.connect(g);
                            g.connect(audioContext.destination);
                            o.type = 'triangle';
                            o.frequency.value = f;
                            g.gain.setValueAtTime(0.1, now + i*0.05);
                            g.gain.linearRampToValueAtTime(0, now + i*0.05 + 0.3);
                            o.start(now + i*0.05);
                            o.stop(now + i*0.05 + 0.3);
                        });
                        break;
                    case 'mistake': // Â§±ÊïóÔºà„Éñ„ÉÉÔºâ
                        osc.type = 'sawtooth';
                        osc.frequency.setValueAtTime(150, now);
                        osc.frequency.linearRampToValueAtTime(100, now + 0.1);
                        gain.gain.setValueAtTime(0.2, now);
                        gain.gain.linearRampToValueAtTime(0, now + 0.1);
                        osc.start(now);
                        osc.stop(now + 0.1);
                        break;
                    case 'click': // „ÇØ„É™„ÉÉ„ÇØÈü≥
                        osc.frequency.setValueAtTime(800, now);
                        gain.gain.setValueAtTime(0.1, now);
                        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                        osc.start(now);
                        osc.stop(now + 0.05);
                        break;
                }
            } catch(e) { }
        }

        // --- 6Âπ¥ÁîüÊº¢Â≠ó„Éá„Éº„Çø (181ÊñáÂ≠ó) ---
        const kanjiString = 
            "Áï∞:„Ç§„Éª„Åì„Å®(„Å™„Çã),ÈÅ∫:„Ç§„Éª„É¶„Ç§,Âüü:„Ç§„Ç≠,ÂÆá:„Ç¶,Êò†:„Ç®„Ç§„Éª„ÅÜ„Å§(„Çã)„Éª„ÅÜ„Å§(„Åô)„Éª„ÅØ(„Åà„Çã),Âª∂:„Ç®„É≥„Éª„ÅÆ(„Å≥„Çã)„Éª„ÅÆ(„Åπ„Çã)„Éª„ÅÆ(„Å∞„Åô),Ê≤ø:„Ç®„É≥„Éª„Åù(„ÅÜ),Êàë:„Ç¨„Éª„Çè„Çå„Éª„Çè,ÁÅ∞:„Ç´„Ç§„Éª„ÅØ„ÅÑ,Êã°:„Ç´„ÇØ,Èù©:„Ç´„ÇØ„Éª„Åã„Çè,Èñ£:„Ç´„ÇØ,Ââ≤:„Ç´„ÉÑ„Éª„Çè(„Çã)„Éª„Çè(„Çå„Çã)„Éª„Çè(„Çä)„Éª„Åï(„Åè),Ê†™:„Åã„Å∂,Âπ≤:„Ç´„É≥„Éª„Åª(„Åô)„Éª„Å≤(„Çã),Â∑ª:„Ç´„É≥„Éª„Åæ(„Åè)„Éª„Åæ„Åç,Áúã:„Ç´„É≥„Éª„Åø(„Çã),Á∞°:„Ç´„É≥,Âç±:„Ç≠„Éª„ÅÇ„Å∂(„Å™„ÅÑ)„Éª„ÅÇ„ÇÑ(„ÅÜ„ÅÑ),Êú∫:„Ç≠„Éª„Å§„Åè„Åà,ÊèÆ:„Ç≠,Ë≤¥:„Ç≠„Éª„Å®„ÅÜ„Å®(„ÅÑ)„Éª„Åü„Å£„Å®(„ÅÑ),Áñë:„ÇÆ„Éª„ÅÜ„Åü„Åå(„ÅÜ),Âê∏:„Ç≠„É•„Ç¶„Éª„Åô(„ÅÜ),‰æõ:„Ç≠„Éß„Ç¶„Éª„ÇØ„Éª„Å®„ÇÇ„Éª„Åù„Å™(„Åà„Çã),ËÉ∏:„Ç≠„Éß„Ç¶„Éª„ÇÄ„Å≠„Éª„ÇÄ„Å™,ÈÉ∑:„Ç≠„Éß„Ç¶„Éª„Ç¥„Ç¶,Âã§:„Ç≠„É≥„Éª„Ç¥„É≥„Éª„Å§„Å®(„ÇÅ„Çã)„Éª„Å§„Å®(„Åæ„Çã),Á≠ã:„Ç≠„É≥„Éª„Åô„Åò,Á≥ª:„Ç±„Ç§,Êï¨:„Ç±„Ç§„Éª„ÅÜ„ÇÑ„Åæ(„ÅÜ),Ë≠¶:„Ç±„Ç§,Âäá:„Ç≤„Ç≠,ÊøÄ:„Ç≤„Ç≠„Éª„ÅØ„Åí(„Åó„ÅÑ),Á©¥:„Ç±„ÉÑ„Éª„ÅÇ„Å™,Áµπ:„Ç±„É≥„Éª„Åç„Å¨,Ê®©:„Ç±„É≥„Éª„Ç¥„É≥,ÊÜ≤:„Ç±„É≥,Ê∫ê:„Ç≤„É≥„Éª„Åø„Å™„ÇÇ„Å®,Âé≥:„Ç≤„É≥„Éª„Ç¥„É≥„Éª„Åä„Åî„Åù(„Åã)„Éª„Åç„Å≥(„Åó„ÅÑ),Â∑±:„Ç≥„Éª„Ç≠„Éª„Åä„ÅÆ„Çå,Âëº:„Ç≥„Éª„Çà(„Å∂),Ë™§:„Ç¥„Éª„ÅÇ„ÇÑ„Åæ(„Çã),Âêé:„Ç≥„Ç¶„Éª„Åç„Åï„Åç,Â≠ù:„Ç≥„Ç¶,Áöá:„Ç≥„Ç¶„Éª„Ç™„Ç¶,Á¥Ö:„Ç≥„Ç¶„Éª„ÇØ„Éª„Åπ„Å´„Éª„Åè„Çå„Å™„ÅÑ,Èôç:„Ç≥„Ç¶„Éª„Åä(„Çä„Çã)„Éª„Åä(„Çç„Åô)„Éª„Åµ(„Çã),Èãº:„Ç≥„Ç¶„Éª„ÅØ„Åå„Å≠,Âàª:„Ç≥„ÇØ„Éª„Åç„Åñ(„ÇÄ),Á©Ä:„Ç≥„ÇØ,È™®:„Ç≥„ÉÑ„Éª„Åª„Å≠,Âõ∞:„Ç≥„É≥„Éª„Åì„Åæ(„Çã),Á†Ç:„Çµ„Éª„Ç∑„É£„Éª„Åô„Å™,Â∫ß:„Ç∂„Éª„Åô„Çè(„Çã),Ê∏à:„Çµ„Ç§„Éª„Åô(„ÇÄ)„Éª„Åô(„Åæ„Åô),Ë£Å:„Çµ„Ç§„Éª„Åï„Å∞(„Åè)„Éª„Åü(„Å§),Á≠ñ:„Çµ„ÇØ,ÂÜä:„Çµ„ÉÑ„Éª„Çµ„ÇØ,Ëöï:„Çµ„É≥„Éª„Åã„ÅÑ„Åì,Ëá≥:„Ç∑„Éª„ÅÑ„Åü(„Çã),ÁßÅ:„Ç∑„Éª„Çè„Åü„Åè„Åó„Éª„Çè„Åü„Åó,Âßø:„Ç∑„Éª„Åô„Åå„Åü,Ë¶ñ:„Ç∑„Éª„Åø(„Çã),Ë©û:„Ç∑,Ë™å:„Ç∑,Á£Å:„Ç∏,Â∞Ñ:„Ç∑„É£„Éª„ÅÑ(„Çã),Êç®:„Ç∑„É£„Éª„Åô(„Å¶„Çã),Â∞∫:„Ç∑„É£„ÇØ,Ëã•:„Ç∏„É£„ÇØ„Éª„Éã„É£„ÇØ„Éª„Çè„Åã(„ÅÑ)„Éª„ÇÇ(„Åó„Åè„ÅØ),Ê®π:„Ç∏„É•,Âèé:„Ç∑„É•„Ç¶„Éª„Åä„Åï(„ÇÅ„Çã)„Éª„Åä„Åï(„Åæ„Çã),ÂÆó:„Ç∑„É•„Ç¶„Éª„ÇΩ„Ç¶,Â∞±:„Ç∑„É•„Ç¶„Éª„Ç∏„É•„Éª„Å§(„Åè)„Éª„Å§(„Åë„Çã),Ë°Ü:„Ç∑„É•„Ç¶„Éª„Ç∑„É•,Âæì:„Ç∏„É•„Ç¶„Éª„Ç∑„Éß„Ç¶„Éª„Ç∏„É•„Éª„Åó„Åü„Åå(„ÅÜ)„Éª„Åó„Åü„Åå(„Åà„Çã),Á∏¶:„Ç∏„É•„Ç¶„Éª„Åü„Å¶,Á∏Æ:„Ç∑„É•„ÇØ„Éª„Å°„Å¢(„ÇÄ)„Éª„Å°„Å¢(„Åæ„Çã)„Éª„Å°„Å¢(„ÇÅ„Çã)„Éª„Å°„Å¢(„Çå„Çã),ÁÜü:„Ç∏„É•„ÇØ„Éª„ÅÜ(„Çå„Çã),Á¥î:„Ç∏„É•„É≥,Âá¶:„Ç∑„Éß,ÁΩ≤:„Ç∑„Éß,Ë´∏:„Ç∑„Éß„Éª„ÇÇ„Çç,Èô§:„Ç∏„Éß„Éª„Ç∏„Éª„ÅÆ„Åû(„Åè),Â∞Ü:„Ç∑„Éß„Ç¶,ÂÇ∑:„Ç∑„Éß„Ç¶„Éª„Åç„Åö„Éª„ÅÑ„Åü(„ÇÄ)„Éª„ÅÑ„Åü(„ÇÅ„Çã),Èöú:„Ç∑„Éß„Ç¶„Éª„Åï„Çè(„Çã),Âüé:„Ç∏„Éß„Ç¶„Éª„Åó„Çç,Ëí∏:„Ç∏„Éß„Ç¶„Éª„ÇÄ(„Åô)„Éª„ÇÄ(„Çå„Çã)„Éª„ÇÄ(„Çâ„Åô),Èáù:„Ç∑„É≥„Éª„ÅØ„Çä,‰ªÅ:„Ç∏„É≥„Éª„Éã,ÂûÇ:„Çπ„Ç§„Éª„Åü(„Çå„Çã)„Éª„Åü(„Çâ„Åô),Êé®:„Çπ„Ç§„Éª„Åä(„Åô),ÂØ∏:„Çπ„É≥,Áõõ:„Çª„Ç§„Éª„Ç∏„Éß„Ç¶„Éª„ÇÇ(„Çã)„Éª„Åï„Åã(„Çã)„Éª„Åï„Åã(„Çì),ËÅñ:„Çª„Ç§„Éª„Ç∑„Éß„Ç¶,Ë™†:„Çª„Ç§„Éª„Åæ„Åì„Å®,ÂÆ£:„Çª„É≥,Â∞Ç:„Çª„É≥„Éª„ÇÇ„Å£„Å±(„Çâ),Ê≥â:„Çª„É≥„Éª„ÅÑ„Åö„Åø,Ê¥ó:„Çª„É≥„Éª„ÅÇ„Çâ(„ÅÜ),Êüì:„Çª„É≥„Éª„Åù(„ÇÅ„Çã)„Éª„Åù(„Åæ„Çã)„Éª„Åó(„Åø„Çã)„Éª„Åó(„Åø),ÂñÑ:„Çº„É≥„Éª„Çà(„ÅÑ),Â•è:„ÇΩ„Ç¶„Éª„Åã„Å™(„Åß„Çã),Á™ì:„ÇΩ„Ç¶„Éª„Åæ„Å©,Ââµ:„ÇΩ„Ç¶„Éª„Å§„Åè(„Çã),Ë£Ö:„ÇΩ„Ç¶„Éª„Ç∑„Éß„Ç¶„Éª„Çà„Åù„Åä(„ÅÜ),Â±§:„ÇΩ„Ç¶,Êìç:„ÇΩ„Ç¶„Éª„Åø„Åï„Åä„Éª„ÅÇ„ÇÑ„Å§(„Çã),Ëîµ:„Çæ„Ç¶„Éª„Åè„Çâ,Ëáì:„Çæ„Ç¶,Â≠ò:„ÇΩ„É≥„Éª„Çæ„É≥,Â∞ä:„ÇΩ„É≥„Éª„Å®„ÅÜ„Å®(„ÅÑ)„Éª„Åü„Å£„Å®(„ÅÑ)„Éª„Å®„ÅÜ„Å®(„Å∂)„Éª„Åü„Å£„Å®(„Å∂),ÂÆÖ:„Çø„ÇØ,ÊãÖ:„Çø„É≥„Éª„Åã„Å§(„Åê)„Éª„Å´„Å™(„ÅÜ),Êé¢:„Çø„É≥„Éª„Åï„Åå(„Åô)„Éª„Åï„Åê(„Çã),Ë™ï:„Çø„É≥,ÊÆµ:„ÉÄ„É≥,Êöñ:„ÉÄ„É≥„Éª„ÅÇ„Åü„Åü(„Åã)„Éª„ÅÇ„Åü„Åü(„Åã„ÅÑ)„Éª„ÅÇ„Åü„Åü(„Åæ„Çã)„Éª„ÅÇ„Åü„Åü(„ÇÅ„Çã),ÂÄ§:„ÉÅ„Éª„ÅÇ„Åü„ÅÑ„Éª„Å≠,ÂÆô:„ÉÅ„É•„Ç¶,Âø†:„ÉÅ„É•„Ç¶,Ëëó:„ÉÅ„Éß„Éª„ÅÑ„Å°„Åò„Çã(„Åó„ÅÑ)„Éª„ÅÇ„Çâ„Çè(„Åô),Â∫Å:„ÉÅ„Éß„Ç¶,È†Ç:„ÉÅ„Éß„Ç¶„Éª„ÅÑ„Åü„Å†(„Åè)„Éª„ÅÑ„Åü„Å†„Åç,ÊΩÆ:„ÉÅ„Éß„Ç¶„Éª„Åó„Åä,Ë≥É:„ÉÅ„É≥,Áóõ:„ÉÑ„Ç¶„Éª„ÅÑ„Åü(„ÅÑ)„Éª„ÅÑ„Åü(„ÇÄ)„Éª„ÅÑ„Åü(„ÇÅ„Çã),Â±ï:„ÉÜ„É≥,Ë®é:„Éà„Ç¶„Éª„ÅÜ(„Å§),ÂÖö:„Éà„Ç¶,Á≥ñ:„Éà„Ç¶,Â±ä:„Å®„Å©(„Åè)„Éª„Å®„Å©(„Åë„Çã),Èõ£:„Éä„É≥„Éª„Åã„Åü(„ÅÑ)„Éª„ÇÄ„Åö„Åã(„Åó„ÅÑ),‰π≥:„Éã„É•„Ç¶„Éª„Å°„Å°„Éª„Å°,Ë™ç:„Éã„É≥„Éª„Åø„Å®(„ÇÅ„Çã),Á¥ç:„Éé„Ç¶„Éª„Éä„ÉÉ„Éª„Éä„É≥„Éª„Éà„Ç¶„Éª„Åä„Åï(„ÇÅ„Çã)„Éª„Åä„Åï(„Åæ„Çã),ËÑ≥:„Éé„Ç¶,Ê¥æ:„Éè,Êãù:„Éè„Ç§„Éª„Åä„Åå(„ÇÄ),ËÉå:„Éè„Ç§„Éª„Åõ„Éª„Åõ„ÅÑ„Éª„Åù„ÇÄ(„Åè),ËÇ∫:„Éè„Ç§,‰ø≥:„Éè„Ç§,Áè≠:„Éè„É≥,Êô©:„Éê„É≥,Âê¶:„Éí„Éª„ÅÑ„Å™„Éª„ÅÑ„ÇÑ,Êâπ:„Éí,Áßò:„Éí„Éª„Å≤(„ÇÅ„Çã),ËÖπ:„Éï„ÇØ„Éª„ÅØ„Çâ,Â•Æ:„Éï„É≥„Éª„Åµ„Çã(„ÅÜ),‰∏¶:„Éò„Ç§„Éª„Å™„Åø„Éª„Å™„Çâ(„Å∂)„Éª„Å™„Çâ(„Åπ„Çã),Èôõ:„Éò„Ç§,Èñâ:„Éò„Ç§„Éª„Å®(„Åò„Çã)„Éª„Å®(„Åñ„Åô)„Éª„Åó(„ÇÅ„Çã)„Éª„Åó(„Åæ„Çã),Áâá:„Éò„É≥„Éª„Åã„Åü,Ë£ú:„Éõ„Éª„Åä„Åé„Å™(„ÅÜ),ÊöÆ:„Éú„Éª„Åè(„Çå„Çã)„Éª„Åè(„Çâ„Åô),ÂÆù:„Éõ„Ç¶„Éª„Åü„Åã„Çâ,Ë®™:„Éõ„Ç¶„Éª„Åä„Å®„Åö(„Çå„Çã)„Éª„Åü„Åö(„Å≠„Çã),‰∫°:„Éú„Ç¶„Éª„É¢„Ç¶„Éª„Å™(„Åè)„Éª„Å™(„Åè„Å™„Çã),Âøò:„Éú„Ç¶„Éª„Çè„Åô(„Çå„Çã),Ê£í:„Éú„Ç¶,Êûö:„Éû„Ç§,Âπï:„Éû„ÇØ„Éª„Éê„ÇØ,ÂØÜ:„Éü„ÉÑ,Áõü:„É°„Ç§,Ê®°:„É¢„Éª„Éú,Ë®≥:„É§„ÇØ„Éª„Çè„Åë,ÈÉµ:„É¶„Ç¶,ÂÑ™:„É¶„Ç¶„Éª„ÇÑ„Åï(„Åó„ÅÑ)„Éª„Åô„Åê(„Çå„Çã),Âπº:„É®„Ç¶„Éª„Åä„Åï„Å™(„ÅÑ),Ê¨≤:„É®„ÇØ„Éª„Åª„Å£(„Åô„Çã)„Éª„Åª(„Åó„ÅÑ),Áøå:„É®„ÇØ,‰π±:„É©„É≥„Éª„Åø„Å†(„Çå„Çã)„Éª„Åø„Å†(„Åô),Âçµ:„É©„É≥„Éª„Åü„Åæ„Åî,Ë¶ß:„É©„É≥,Ë£è:„É™„Éª„ÅÜ„Çâ,Âæã:„É™„ÉÑ„Éª„É™„ÉÅ,Ëá®:„É™„É≥„Éª„ÅÆ„Åû(„ÇÄ),Êúó:„É≠„Ç¶„Éª„Åª„Åå(„Çâ„Åã),Ë´ñ:„É≠„É≥";
        
        // „Éá„Éº„ÇøÂ§âÊèõ
        const kanjiData = kanjiString.split(',').map(item => {
            const parts = item.split(':');
            return { char: parts[0], reading: parts[1] };
        });

        // Áä∂ÊÖãÁÆ°ÁêÜÔºà6Âπ¥ÁîüÂ∞ÇÁî®„Ç≠„Éº v2Ôºâ
        let progressPractice = JSON.parse(localStorage.getItem('kanjiMasterPractice_G6_v2')) || {};
        let progressTest = JSON.parse(localStorage.getItem('kanjiMasterTest_G6_v2')) || {};
        
        let writer;
        let currentChar = null;
        let currentMode = 'practice';

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            if (screenId === 'list-screen') {
                document.getElementById('search-input').value = '';
                renderList();
            }
        }

        function selectMode(mode) {
            playSound('click');
            currentMode = mode;
            showScreen('list-screen');
        }

        function renderList() {
            const grid = document.getElementById('kanji-grid');
            grid.innerHTML = '';
            
            const badge = document.getElementById('mode-display');
            const counter = document.getElementById('star-counter');
            const targetProgress = (currentMode === 'practice') ? progressPractice : progressTest;

            if (currentMode === 'practice') {
                badge.textContent = "‚≠ê „Çå„Çì„Åó„ÇÖ„ÅÜ";
                badge.style.backgroundColor = "#FFD600";
                badge.style.color = "#333";
            } else {
                badge.textContent = "üëë „ÉÜ„Çπ„Éà";
                badge.style.backgroundColor = "#F50057";
                badge.style.color = "#FFF";
            }

            let totalCount = 0;
            kanjiData.forEach(item => {
                if (targetProgress[item.char]) totalCount++;
            });
            counter.innerText = totalCount;

            const searchText = document.getElementById('search-input').value;
            const filteredData = kanjiData.filter(item => {
                return item.char.includes(searchText) || item.reading.includes(searchText);
            });

            if (filteredData.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#888; margin-top:20px;">„Åø„Å§„Åã„Çä„Åæ„Åõ„Çì...</div>';
                return;
            }

            filteredData.forEach(item => {
                const isCleared = targetProgress[item.char];
                const card = document.createElement('div');
                card.className = `kanji-card`;
                if (isCleared) {
                    card.classList.add(currentMode === 'practice' ? 'cleared-practice' : 'cleared-test');
                }
                card.innerHTML = `${item.char}<div class="mark star-mark">‚≠ê</div><div class="mark crown-mark">üëë</div>`;
                card.onclick = () => {
                    playSound('click');
                    startApp(item);
                };
                grid.appendChild(card);
            });
        }

        function startApp(item) {
            currentChar = item;
            showScreen('practice-screen');
            document.getElementById('result-overlay').classList.remove('active');

            const screen = document.getElementById('practice-screen');
            const msgArea = document.getElementById('message-area');
            const titleDisplay = document.getElementById('current-kanji-title');
            const readingDisplay = document.getElementById('current-reading-detail');
            
            const readingText = item.reading;

            if (currentMode === 'test') {
                screen.classList.add('test-bg');
                msgArea.innerText = "„Åì„ÅÆ „Åã„Çì„Åò „Çí „Åã„Åì„ÅÜÔºÅ";
                msgArea.style.color = "#C2185B";
                
                titleDisplay.innerText = "Ôºü";
                readingDisplay.innerText = readingText; 
                readingDisplay.style.fontSize = "1.2rem";
            } else {
                screen.classList.remove('test-bg');
                msgArea.innerText = "„ÅÜ„Åô„ÅÑ„Åõ„Çì„Çí „Å™„Åû„Çç„ÅÜÔºÅ";
                msgArea.style.color = "#1A237E";
                
                titleDisplay.innerText = item.char;
                readingDisplay.innerText = readingText;
                readingDisplay.style.fontSize = "1rem";
            }

            document.getElementById('character-target-div').innerHTML = '';
            document.getElementById('anim-star').style.display = 'none';
            document.getElementById('anim-crown').style.display = 'none';

            try {
                if (typeof HanziWriter === 'undefined') throw new Error("„Éç„ÉÉ„Éà„Å´„Å§„Å™„Åå„Å£„Å¶„ÅÑ„Åæ„Åõ„Çì");
                
                const isTest = (currentMode === 'test');
                writer = HanziWriter.create('character-target-div', item.char, {
                    width: 300, height: 300, padding: 10,
                    showOutline: !isTest,
                    strokeAnimationSpeed: 1, delayBetweenStrokes: 200,
                    radicalColor: '#304FFE', drawingWidth: 25,
                    outlineColor: '#DDD', strokeColor: '#333',
                    highlightColor: '#7986CB', 
                    showHintAfterMisses: 1,
                    
                    charDataLoader: function(char, onComplete) {
                        // ÂÑ™ÂÖàÂ∫¶„ÅÆÈ´ò„ÅÑ„Éá„Éº„Çø„ÇΩ„Éº„Çπ„Çí‰ΩøÁî®
                        fetch(`https://cdn.jsdelivr.net/gh/chanind/hanzi-writer-data-jp@master/data/${char}.json`)
                            .then(res => {
                                if (!res.ok) throw new Error('JP Data Not Found');
                                return res.json();
                            })
                            .then(data => onComplete(data))
                            .catch(err => {
                                fetch(`https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/${char}.json`)
                                    .then(res => res.json())
                                    .then(data => onComplete(data));
                            });
                    }
                });
                startQuiz();
            } catch (e) {
                alert("„Ç®„É©„Éº: " + e.message);
            }
        }

        function startQuiz() {
            writer.quiz({
                onMistake: function() {
                    playSound('mistake');
                    const msg = document.getElementById('message-area');
                    msg.innerText = (currentMode === 'test') ? "„Åä„Åó„ÅÑÔºÅ „Éí„É≥„Éà„Çí„Åø„Å¶" : "„Åì„Åì„Å†„ÇàÔºÅ";
                    msg.style.color = "#D32F2F";
                },
                onCorrectStroke: function() {
                    playSound('success');
                    const msg = document.getElementById('message-area');
                    msg.innerText = "„ÅÑ„ÅÑ„Å≠ÔºÅ";
                    msg.style.color = "#2E7D32";
                },
                onComplete: function() {
                    handleComplete();
                }
            });
        }

        function handleComplete() {
            playSound('complete');
            const msg = document.getElementById('message-area');
            const resultTitle = document.getElementById('result-title-text');
            const titleDisplay = document.getElementById('current-kanji-title');

            if(currentMode === 'test') {
                titleDisplay.innerText = currentChar.char;
            }
            
            if (currentMode === 'practice') {
                msg.innerText = "„Åß„Åç„Åü„ÉºÔºÅ ‚≠ê„Ç≤„ÉÉ„ÉàÔºÅ";
                resultTitle.innerText = "„Åß„Åç„Åü„ÉºÔºÅ‚≠ê"; 
                resultTitle.style.color = "#FBC02D";
                document.getElementById('anim-star').style.display = 'block';
                
                progressPractice[currentChar.char] = true;
                localStorage.setItem('kanjiMasterPractice_G6_v2', JSON.stringify(progressPractice));
            } else {
                msg.innerText = "„Åô„Åî„ÅÑÔºÅÔºÅ üëë„Ç≤„ÉÉ„ÉàÔºÅ";
                resultTitle.innerText = "„Åô„Åî„ÅÑÔºÅüëë"; 
                resultTitle.style.color = "#F50057";
                document.getElementById('anim-crown').style.display = 'block';
                
                progressTest[currentChar.char] = true;
                localStorage.setItem('kanjiMasterTest_G6_v2', JSON.stringify(progressTest));
            }

            setTimeout(() => {
                document.getElementById('result-overlay').classList.add('active');
            }, 1000);
        }

        function retry() { 
            playSound('click');
            startApp(currentChar); 
        }

        function goNext() {
            playSound('click');
            const searchText = document.getElementById('search-input').value;
            const filteredData = kanjiData.filter(item => {
                return item.char.includes(searchText) || item.reading.includes(searchText);
            });
            const currentIndex = filteredData.findIndex(k => k.char === currentChar.char);
            
            if (currentIndex >= 0 && currentIndex < filteredData.length - 1) {
                startApp(filteredData[currentIndex + 1]);
            } else {
                alert("„Åì„Çå„Åß„Åä„Åó„Åæ„ÅÑÔºÅ Â∞èÂ≠¶Ê†°„ÅÆÊº¢Â≠ó„Éû„Çπ„Çø„Éº„Å†ÔºÅ");
                showScreen('list-screen');
            }
        }

        function resetData() {
            if (confirm("„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„Çí „Åë„Åó„Åæ„Åô„ÅãÔºü")) {
                localStorage.removeItem('kanjiMasterPractice_G6_v2');
                localStorage.removeItem('kanjiMasterTest_G6_v2');
                progressPractice = {};
                progressTest = {};
                renderList();
            }
        }
    </script>
</body>
</html>
